---
layout: post
title: TDD笔记2
category: code
tag: tdd
---

## 关于mock

个人感觉mock是测试中一个比较掌握的点,所以试图单独拿出来说明下

## mock的引入

在开发过程中,会遇到各种各样的依赖关系.如果依赖的仅仅是local的类还好说,至少之间的交互最复杂也莫过于进程间rpc调用了,普通的也就是函数调用的,这些调用一般都比较快,而且稳定,返回结果一般也是可控的.相反,还有一些依赖关系是不可控的,最local的比如本地文件系统的操作,稍微远点的比如远程数据库访问,下游依赖服务调用之类的,这些依赖关系存在3个缺点:

1. **响应慢** 本地也好,网络连接也好,相比函数调用而言,都是耗时的复杂操作,测试能被很好的使用,一个标准就是要快(大型c++编译本来就够慢了,测试再慢,活不活了)
2. **不稳定** 依赖的服务无法保证在测试期间的稳定性,如果test失败了,究竟是逻辑有误,还是仅仅服务不稳定呢?这个就加大了测试分析的难度(可能就还得看操作日志之类的)
3. **无定制** 无法控制服务返回的结果,很多逻辑都无法进行全面测试.比如想看看文件系统出错时的处理,这种情况要想依赖os本身来弄,概率基本可以忽略了,所以这部分逻辑就相当于没有测试过

所以祭出软件开发中的大杀器--**间接层**,将实际的逻辑处理和依赖服务隔离,然后就可以在中间动动手脚了

比如,用一个假的依赖服务模块替换掉真实实现,测试的时候就可以主要关注上层逻辑的处理,需要的依赖服务的结果可以随心所欲的定制,因此各种千奇百怪的情况都可以模拟

这样的一个虚假依赖服务模块,就是一个真实服务的mock,它的引入,就是为了解决上面的3大问题

## 关于mock的疑问

话虽说的好听,但想要达到mock的效果,不仅对系统设计会带来影响,对于模拟的真实服务,也是有一定的问题的

### 系统设计

可以看到,如果要引入mock,那么必然就需要引入新的间接层了,上层逻辑完全的依赖**注入**的接口,下层的实现在真实与mock之间切换,就可以完成对逻辑层面的测试

但这样是存在问题的:

* **有无必要** 基于接口,这是开发的基本原则,但如果对应的实现只有一个的话,很多情况下我们就直接忽略了接口,完全的依赖于唯一的实现了(比如我们内部依赖的MySql和curl之类的).引入间接层,大部分情况下是引入虚的继承结构,性能另说,单就这一个接口只对一个实现,颇有浪费的感觉
* **依赖注入** 依赖的底层服务,是需要注入到逻辑层的使用中,不论是通过初始化,或者随后的set,表示逻辑层,至少和底层服务交互的这个层次,是需要修改结构的.如果依赖的服务很多(比如cache,数据库,curl,tcp连接,配置文件等),这些注入就是问题了

其实在写完上面的问题后,我就了然了,这些问题之所以会存在,应该不是mock带来的,而是系统设计本身有问题,比如基于接口编程,在这里变成了基于实现,bad smell,再比如多依赖,从名字上就违反了单一职责原则(SRP),是应该拆分的,而拆分之后不仅架构上进步,也更容易进行注入测试了

当然,如果是基于历史代码的话,就是另一回事了,这个后续应该还会提到.但不难看出来,从测试的角度出发,是会强迫我们采用一些比较好的设计方案的,这应该也是TDD的关键目标吧

### 定制结果

底层服务有时并不是简单的返回字符串或值,有的时候是非常复杂的二进制格式,虽然是可定制的,但如何定制,怎么定制,同样是个复杂的工程

就比如我们自己的服务,上下游之间的结果至少是k数量级的,里面各种字段各种复杂,有历史的,也有随意添加的,还有不明所以的,试图拼装这样的结果是比较痛苦的,所以测试的时候,一般就偷懒,直接连接测试或线上的真实服务了

一个好的解决方法估计是采用合理的通信协议(伤过心之后才知道这个有多重要),不论是protobuf,thrift还是json,xml,这些其实都不是重点,这些都是手段,是关于如何通信的,真正的关键是通信内容,这点上可能目前还没有太深的研究,还需要进一步的学习

不过这个方法,对于历史系统是无能为力的,此时,可能首先获取一个真实结果,再对其进行适当修改,应该是个还可以的应对方式

如果服务结果本身就不是确定的,或者逻辑层的处理不是确定的,比如都引入了随机性,那么在最后断言时,就需要小心的.这个可以从系统层面解决,将随机性作为依赖的一种注入即可,测试中可以使用确定的随机性mock即可,这是后话了

### 总结

可以看到,mock的种种问题,其实都反映了系统本身存在的问题,对于历史系统,可能就要走上测试-重构之路,对于新系统的话,就完全需要按照TDD循环,以期得到方便测试,同时也设计良好的架构

注意测试在二种情况下扮演的角色,后续还会详细讨论的











