---
layout: post
title: UnixV6分析(1) 硬件
category: code
tag: xv6
---

废话我就不多言了,背景知识请看附后的参考,我就直接介绍v6存在的硬件环境,php11-40

## 单位

php11-40是以8bit为1B,16bit为1word的机器,在后续讨论操作的时候,会经常用到word(字)这个单位,需要记住这个是16bit,而不是现在通用的32bit

和32有关的是一个block(块)的概念,1block是32word,也就是64B.当然,此32和x86的32不是一个数量级,看代码要随时记住我们研究的是v6.块的重要性在于php11-40的很多机器内部表示都是以块为单位的,所以需要记住.

## 地址

其实从单位的名称来看,很容易就看到php11-40是16bit的机器(话说每个硬件平台不都是以**字**为名称的么;)),也就是说,我们可以操作的地址空间就是2^16B,即65536B(记住,我们的地址一般指的都是字节地址)

不过很奇怪(?搞笑?)的是,php11-40提供的是18bit的地址线,也就是我们其实可以使用的是2^18B的空间的,具体的实现我们之后讨论,现在的问题是我们如何表达地址.v6的代码和分析的统一的表达是使用18bit,并利用八进制三三分类,就像下面这样

![地址表达](/image/word_in_v6.png)

前面空余的2bit什么值呢?自然最好的情况是0了,这样就没有任何冲突了,不过实际上这里php11-40有个很巧的办法,对于高两位自有安排.

## 奇特的硬件交互

了解底层知识的人都了解,那个时候每天要打交道的就是寄存器,状态字,内存,时钟,中断和各种驱动程序,这些东西都有一些特殊的标记来使用,比如寄存器,我们使用eax,ebx等来表示通用寄存器,gpt,lpt等表示专用寄存器,eflag来表示状态字,0xabcd表示内存位置等.

而在php11-40中,有一个很奇特的设计,就是硬件的内存地址,意思就是我们不用考虑什么什么奇特的名称,php11-40为每个硬件都提供了一个都应的内存地址,我们直接处理这个地址的值,就相当于和这些硬件进行了交互.

比如,0xabcd表示某个时钟,那么我们填入对应的值就相当于设置了时间,读入了其中的值,就相当于读取的时钟的时间(当然,对于php11-40来说,处理的单位是字,就是2B的值)

这样的奇特设计,带来的好处就是不需要那么多的特殊的硬件指令了,比如我们不用in/out来表示端口输入输出,直接操作内存就完成了.唯一的缺点就是有了很多特殊的内存位置需要记住(或者靠手册)

当然,这里还有一个问题,我们能随随便便的给一个内存地址么?当然不是.那怎么办?自然是有规定的特殊位置了,此时就显示了刚才我们讨论的16bit地址和18bit地址线的神奇作用了.

php11-40有特殊规定,地址空间的最高4KB是留给特殊硬件的,也就是说,地址0170000~0177777我们是不能使用的,但这个16bit的地址怎么转到18bit地址线呢?自然,这些地址不能转换到对应的0170000~0177777,因为18bit的地址线下,这段地址是在整个地址中间的一段,怎么可能在这里.最合适的位置还是18bit的最高4KB,也就是地址线0770000~0777777.

看到没?

* 16bit
* 0 0 1 | 1 1 1 | 0 0 0 | 0 0 0 | 0 0 0 | 0 0 0
* 1 1 1 | 1 1 1 | 0 0 0 | 0 0 0 | 0 0 0 | 0 0 0
* 18bit

pdp11-40的聪明地方就是当我们引用最高4KB的时候,自动就把地址线最高2bit设置为1,直接就映射成了可能物理地址空间的最高4KB,保证了这个的统一性

## 内存管理

上面已经介绍了地址转换和特殊硬件处理的神奇,接下来就是和这个相关的内存管理了.其实和x86相比,pdp11-40的内存管理相当的简单了.

本质来看,pdp11-40的内存管理相当于简化版的8086实模式,简化的地方在于段.实模式的最大灵活性就是分段,而在pdp11-40,亦然.

pdp11-40有两种模式,基本内存模式和扩展内存模式.基本内存模式非常基本,基本就是16bit地址直接对应18bit地址(除了最高4KB),没有任何保护,没有任何限制,任何程序都可以控制整个系统.可以看到,这种模式不仅**很傻很天真**,而且并没有利用到地址线剩余的2bit(浪费啊~).

还有一种模式就是扩展内存模式,充分的利用了高2bit,此时的内存管理颇像8086实模式,有了段的分类.多了一个间接层,自然随之而来的就是权限和控制,还有灵活的的定位.

具体的方法策略下文会讲,此处不多言,我们需要明白两点:

1. 内存模式的切换类似x86的保护模式一般,有专门的硬件来控制
2. 扩展内存模式是我们重点讨论的模式.基本内存模式基本就在初始化的时候我们要处理,除去系统初始化的时候,我们不再区分,直接指的就是扩展内存模式(很像x86的保护模式吧)

## 寄存器

寄存器这种重要的部件,我们自然要拿来看看.在php11-40中其实有9个通用寄存器

(待续..)












